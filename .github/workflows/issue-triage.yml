name: Issue triage (repo-aware)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage issue with github-script
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue || context.payload;
            const bodyRaw = (issue.body || '').toString();
            const body = bodyRaw.toLowerCase();
            const labelsToAdd = new Set();

            // core directories to watch
            const coreDirs = ['agent_monitoring', 'ai-agent', 'llm_project'];
            const mentionsCore = coreDirs.some(d => body.includes(d));

            // detect level selections
            if (body.includes('beginner')) labelsToAdd.add('beginner');
            if (body.includes('intermediate')) labelsToAdd.add('intermediate');
            if (body.includes('advanced')) labelsToAdd.add('advanced');

            // first-time contributor
            if (body.includes('this is my first issue') || body.includes('first issue') || body.includes('first-time')) {
              labelsToAdd.add('good first issue');
            }

            // classification heuristics
            if (body.includes('bug') || body.includes('[bug]')) labelsToAdd.add('bug');
            if (body.includes('feature') || body.includes('[feature]') || body.includes('feat:')) labelsToAdd.add('enhancement');

            // moderation heuristics
            const needsModeration = mentionsCore || /core|api|security|breaking change|breaking/.test(body);
            if (needsModeration) labelsToAdd.add('needs-moderation');

            if (labelsToAdd.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: Array.from(labelsToAdd)
              });
            }

            if (needsModeration) {
              // try to read moderators file and mention them (safe parsing without external deps)
              try {
                const content = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: '.github/MODERATORS.yml'
                });
                const raw = Buffer.from(content.data.content, 'base64').toString();
                const lines = raw.split(/\r?\n/);
                let mods = [];
                const start = lines.findIndex(l => l.trim().startsWith('moderators:'));
                if (start !== -1) {
                  for (let i = start + 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line.startsWith('-')) break;
                    const name = line.replace(/^-+\s*/, '').replace(/^@/, '').trim();
                    if (name) mods.push('@' + name);
                  }
                }
                const mention = (mods.length > 0) ? mods.join(' ') : '';
                const comment = `:rotating_light: This issue touches core components and needs moderator review. ${mention} â€” please review and add the \`moderator-approved\` label when ready.`;
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: comment
                });
              } catch (e) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `:rotating_light: This issue appears to require moderator review (couldn't read .github/MODERATORS.yml). Please ask a maintainer to add \`moderator-approved\`.`
                });
              }
            }
